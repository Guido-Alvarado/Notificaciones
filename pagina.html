<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel de Preferencias</title>
<style>
  /* Reset básico */
  * { box-sizing: border-box; margin: 0; padding: 0; font-family: sans-serif; }
  body { background-color: #1f2937; color: #fff; padding: 20px; }

  /* Grid principal */
  .grid-container {
    display: grid;
    grid-template-columns: 1fr;
    gap: 20px;
  }
  @media(min-width: 768px){
    .grid-container { grid-template-columns: 1fr 3fr; }
  }

  /* Panel Notificaciones */
  .panel { background: #065f46; padding: 20px; border-radius: 12px; box-shadow: inset 0 0 10px #000; }
  .panel h2 { font-size: 1.5rem; margin-bottom: 10px; border-bottom: 2px solid #047857; padding-bottom: 5px; display: flex; align-items: center; }
  .panel h2 svg { margin-right: 8px; }
  .notifications { max-height: 400px; overflow-y: auto; }
  .notification { padding: 10px; border-left: 4px solid #10b981; margin-bottom: 5px; border-radius: 4px; transition: background 0.3s; }
  .notification:hover { background: #047857; }
  .notification small { color: #d1d5db; }

  /* Scroll personalizado */
  .notifications::-webkit-scrollbar { width: 6px; }
  .notifications::-webkit-scrollbar-thumb { background: rgba(16,185,129,0.5); border-radius: 10px; }
  .notifications::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }

  /* Pagos Recibidos */
  .pagos { background: #065f46; padding: 20px; border-radius: 12px; box-shadow: 0 0 10px #000; }
  .pagos h2 { font-size: 1.5rem; margin-bottom: 10px; border-bottom: 2px solid #047857; padding-bottom: 5px; }
  .grid-pagos { display: grid; grid-template-columns: 1fr; gap: 10px; text-align: center; }
  @media(min-width: 768px){ .grid-pagos { grid-template-columns: repeat(3, 1fr); } }
  .pago { background: #047857; padding: 15px; border-radius: 8px; }
  .pago .label { color: #d1d5db; font-size: 0.9rem; }
  .pago .value { font-weight: 800; font-size: 1.2rem; color: #a7f3d0; }

  /* Configuración */
  .config { background: #111827; padding: 20px; border-radius: 12px; box-shadow: 0 0 10px #000; }
  .config h2, .config h3 { margin-bottom: 10px; border-bottom: 2px solid #374151; padding-bottom: 5px; }
  .grid-config { display: grid; grid-template-columns: 1fr; gap: 10px; }
  @media(min-width: 768px){ .grid-config { grid-template-columns: repeat(2, 1fr); } }
  .config-toggle { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-radius: 8px; background: rgba(107,114,128,0.5); cursor: pointer; transition: background 0.3s; }
  .config-toggle.active { background: #10b981; }
  .config-toggle .info p { margin-bottom: 2px; }
  .config-toggle .info .desc { font-size: 0.8rem; color: #d1d5db; }
  .switch { width: 40px; height: 20px; background: #6b7280; border-radius: 20px; display: flex; align-items: center; padding: 2px; transition: justify-content 0.3s; }
  .switch .knob { width: 16px; height: 16px; background: white; border-radius: 50%; transition: transform 0.3s; }
  .config-toggle.active .switch { background: #22c55e; justify-content: flex-end; }

  /* Selector de rol */
  .role-selector { display: flex; align-items: center; justify-content: space-between; background: #1f2937; padding: 15px; border-radius: 12px; margin-bottom: 20px; }
  .role-selector h1 { display: flex; align-items: center; font-size: 1.5rem; }
  .role-selector h1 svg { margin-right: 8px; color: #22c55e; }
  .role-buttons button { padding: 8px 16px; border: none; cursor: pointer; font-weight: bold; border-radius: 999px; transition: all 0.3s; }
  .role-buttons button.active { background: #10b981; box-shadow: 0 2px 5px #000; color: white; }
  .role-buttons button:not(.active) { background: #374151; color: white; }
  .role-buttons button:not(.active):hover { background: #4b5563; }
</style>
</head>
<body>

<!-- Selector de rol -->
<div class="role-selector">
  <h1>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="7" r="4"/>
      <path d="M6 21v-2a6 6 0 0 1 12 0v2"/>
    </svg>
    Panel de Preferencias
  </h1>
  <div class="role-buttons">
    <button id="alumnoBtn" class="active">Alumno</button>
    <button id="adminBtn">Administrador</button>
  </div>
</div>

<!-- Grid principal -->
<div class="grid-container">
  <!-- Columna Izquierda: Notificaciones -->
  <div>
    <div class="panel">
      <h2>
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 8a6 6 0 0 0-12 0c0 7-3 9-3 9h18s-3-2-3-9"/>
          <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
        </svg>
        Notificaciones Recientes
      </h2>
      <div class="notifications" id="notificationsList">
        <!-- Notificaciones por API -->
      </div>
    </div>
  </div>

  <!-- Columna Derecha: Pagos y Configuración -->
  <div>
    <!-- Pagos Recibidos -->
    <div class="pagos">
      <h2>Recibidas (Estado de Cuotas)</h2>
      <div class="grid-pagos">
        <div class="pago">
          <div class="label">Último Pago</div>
          <div class="value" id="lastPaymentDate">-</div>
        </div>
        <div class="pago">
          <div class="label">Pago Pendiente</div>
          <div class="value" id="pendingPayment">-</div>
        </div>
        <div class="pago">
          <div class="label">Cuota Próxima a Vencer</div>
          <div class="value" id="nextDueDate">-</div>
        </div>
      </div>
    </div>

    <!-- Configuración -->
    <div class="config" id="configContainer">
      <!-- Contenido dinámico según rol -->
    </div>
  </div>
</div>

<script>
  // Config API y rol por defecto (simulación)
  const API_BASE = 'http://localhost:3000';
  const defaultHeaders = {
    'Content-Type': 'application/json',
    'X-Role': 'alumno',
    'X-User-Id': '2'
  };

  // Helpers de carga desde API
  async function loadNotifications(){
    const res = await fetch(`${API_BASE}/api/notifications`, { headers: defaultHeaders });
    const notifications = await res.json();
    const notificationsList = document.getElementById('notificationsList');
    notificationsList.innerHTML = '';
    notifications.forEach(n => {
      const div = document.createElement('div');
      div.className = 'notification';
      div.innerHTML = `<p>${n.text}</p><small>${n.date}</small>`;
      notificationsList.appendChild(div);
    });
  }

  async function loadPaymentsStatus(){
    const res = await fetch(`${API_BASE}/api/payments/status`, { headers: defaultHeaders });
    const data = await res.json();
    document.getElementById('lastPaymentDate').textContent = data.lastPaymentDate || '-';
    document.getElementById('pendingPayment').textContent = data.pending || '-';
    document.getElementById('nextDueDate').textContent = data.nextDueDate || '-';
  }

  // Preferencias
  let currentPrefs = null;

  async function loadPreferences(){
    const res = await fetch(`${API_BASE}/api/preferences`, { headers: defaultHeaders });
    currentPrefs = await res.json();
  }

  function createConfigToggle(title, desc, key, initial=false){
    const div = document.createElement('div');
    div.className = 'config-toggle' + (initial ? ' active' : '');
    div.dataset.key = key;
    div.innerHTML = `
      <div class="info">
        <p>${title}</p>
        <p class="desc">${desc}</p>
      </div>
      <div class="switch"><div class="knob"></div></div>
    `;
    div.addEventListener('click', async ()=>{
      div.classList.toggle('active');
      await savePreferences();
    });
    return div;
  }

  function collectPreferencesFromUI(){
    const mapToggle = (key) => !!configContainer.querySelector('\`.config-toggle[data-key="\${key}"]\`')?.classList.contains('active');

    const channels = {
      app: mapToggle('channels.app'),
      email: mapToggle('channels.email'),
      sms: mapToggle('channels.sms'),
      whatsapp: mapToggle('channels.whatsapp'),
    };

    const dndFrom = document.getElementById('dndFrom') ? Number(document.getElementById('dndFrom').value) : 22;
    const dndTo = document.getElementById('dndTo') ? Number(document.getElementById('dndTo').value) : 7;

    const events = {
      upcoming_due: mapToggle('events.upcoming_due'),
      overdue: mapToggle('events.overdue'),
      payment_confirmed: mapToggle('events.payment_confirmed'),
    };

    return { channels, dnd: { from: dndFrom, to: dndTo }, events };
  }

  async function savePreferences(){
    const body = collectPreferencesFromUI();
    await fetch(`${API_BASE}/api/preferences`, {
      method: 'PUT',
      headers: defaultHeaders,
      body: JSON.stringify(body)
    });
  }

  const configContainer = document.getElementById('configContainer');

  async function renderConfig(role){
    configContainer.innerHTML = '';
    if(role === 'alumno'){
      if(!currentPrefs) await loadPreferences();

      const header = document.createElement('h3');
      header.textContent = 'Preferencias por Canal de Envío';
      configContainer.appendChild(header);

      const grid = document.createElement('div');
      grid.className = 'grid-config';
      grid.appendChild(createConfigToggle('Notificaciones en la App','Avisos en tiempo real dentro del sistema.','channels.app', !!currentPrefs.channels.app));
      grid.appendChild(createConfigToggle('Correo Electrónico','Recibir resúmenes y alertas importantes por email.','channels.email', !!currentPrefs.channels.email));
      grid.appendChild(createConfigToggle('SMS','Alertas críticas por mensaje de texto.','channels.sms', !!currentPrefs.channels.sms));
      grid.appendChild(createConfigToggle('WhatsApp','Comunicación a través de tu número registrado.','channels.whatsapp', !!currentPrefs.channels.whatsapp));
      configContainer.appendChild(grid);

      const header2 = document.createElement('h3');
      header2.textContent = 'Horario "No Molestar"';
      configContainer.appendChild(header2);

      const noMolestar = document.createElement('div');
      noMolestar.style.display = 'flex';
      noMolestar.style.alignItems = 'center';
      noMolestar.style.gap = '10px';
      noMolestar.style.background = 'rgba(107,114,128,0.5)';
      noMolestar.style.padding = '10px';
      noMolestar.style.borderRadius = '8px';
      noMolestar.innerHTML = `
        <label>Desde las:</label>
        <select id="dndFrom">${Array.from({length:24}).map((_,i)=>`<option value="${i}" ${currentPrefs.dnd.from===i?'selected':''}>${i<10?'0'+i:i}:00</option>`).join('')}</select>
        <label>Hasta las:</label>
        <select id="dndTo">${Array.from({length:24}).map((_,i)=>`<option value="${i}" ${currentPrefs.dnd.to===i?'selected':''}>${i<10?'0'+i:i}:00</option>`).join('')}</select>
        <button id="saveDndBtn" style="margin-left:auto;background:#10b981;color:white;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;">Guardar</button>
      `;
      configContainer.appendChild(noMolestar);
      noMolestar.querySelector('#saveDndBtn').addEventListener('click', savePreferences);

      const header3 = document.createElement('h3');
      header3.textContent = 'Preferencias por Tipo de Evento';
      configContainer.appendChild(header3);

      const grid2 = document.createElement('div');
      grid2.className = 'grid-config';
      grid2.appendChild(createConfigToggle('Cuota próxima a vencer','Aviso 7 días antes de la fecha límite.','events.upcoming_due', !!currentPrefs.events.upcoming_due));
      grid2.appendChild(createConfigToggle('Cuota vencida','Alerta sobre pagos pendientes de inmediato.','events.overdue', !!currentPrefs.events.overdue));
      grid2.appendChild(createConfigToggle('Pago confirmado','Notificación al procesarse el pago.','events.payment_confirmed', !!currentPrefs.events.payment_confirmed));
      configContainer.appendChild(grid2);
    } else {
      const header = document.createElement('h3');
      header.textContent = 'Configuración Administrador';
      configContainer.appendChild(header);
      const p = document.createElement('p');
      p.textContent = 'Opciones de gestión y control disponibles solo para Administrador.';
      p.style.fontSize = '0.9rem';
      configContainer.appendChild(p);

      const grid = document.createElement('div');
      grid.className = 'grid-config';
      const div1 = document.createElement('div');
      div1.style.display='flex'; div1.style.justifyContent='space-between'; div1.style.alignItems='center'; div1.style.background='#374151'; div1.style.padding='10px'; div1.style.borderRadius='8px';
      div1.innerHTML=`<p>Gestión de Plantillas de Notificación</p><button style="background:#10b981;color:white;border:none;padding:5px 10px;border-radius:5px;" onclick="window.location.href='Pagina 2.html'">Abrir</button>`;
      const div2 = document.createElement('div');
      div2.style.display='flex'; div2.style.justifyContent='space-between'; div2.style.alignItems='center'; div2.style.background='#374151'; div2.style.padding='10px'; div2.style.borderRadius='8px';
      div2.innerHTML=`<p>Umbrales de Cuotas Vencidas (Días)</p><input type="number" value="5" style="width:50px;text-align:center;background:#1f2937;color:white;border-radius:5px;border:none;padding:2px;">`;
      grid.appendChild(div1); grid.appendChild(div2);
      configContainer.appendChild(grid);
    }
  }

  // Botones de rol: simulan headers
  document.getElementById('alumnoBtn').addEventListener('click', async ()=>{
    defaultHeaders['X-Role'] = 'alumno';
    defaultHeaders['X-User-Id'] = 'alumno1';
    await loadPreferences();
    await renderConfig('alumno');
    document.getElementById('alumnoBtn').classList.add('active');
    document.getElementById('adminBtn').classList.remove('active');
  });
  document.getElementById('adminBtn').addEventListener('click', async ()=>{
    defaultHeaders['X-Role'] = 'admin';
    defaultHeaders['X-User-Id'] = 'admin1';
    await renderConfig('admin');
    document.getElementById('adminBtn').classList.add('active');
    document.getElementById('alumnoBtn').classList.remove('active');
  });

  // Init
  (async function init(){
    await loadPreferences();
    await renderConfig('alumno');
    await loadNotifications();
    await loadPaymentsStatus();
  })();
</script>

</body>
</html>